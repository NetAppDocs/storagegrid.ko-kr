---
permalink: audit/audit-message-flow-and-retention.html 
sidebar: sidebar 
keywords: storagegrid, audit, message, flow, retention 
summary: 모든 StorageGRID 서비스는 정상적인 시스템 작동 중에 감사 메시지를 생성합니다. 이러한 감사 메시지가 StorageGRID 시스템을 통해 audit.log 파일로 이동하는 방법을 이해해야 합니다. 
---
= 감사 메시지 흐름 및 보존
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
모든 StorageGRID 서비스는 정상적인 시스템 작동 중에 감사 메시지를 생성합니다. 이러한 감사 메시지가 StorageGRID 시스템을 통해 파일로 이동하는 방법을 이해해야 `audit.log` 합니다.

감사 메시지 및 감사 메시지 보존에 대한 다음 워크플로는 StorageGRID 가 *관리 노드/로컬 노드* 또는 *관리 노드 및 외부 시스템 로그 서버*로 구성된 경우에만 적용됩니다.  StorageGRID "로컬 노드만"(기본값) 또는 "외부 syslog 서버"로 구성된 경우 감사 메시지는 각 노드에 로컬로 저장됩니다. `/var/local/log/localaudit.log` 파일로 관리 노드나 스토리지 노드에서 처리할 수 없습니다.



== 감사 메시지 흐름

StorageGRID *관리 노드/로컬 노드* 또는 *관리 노드 및 외부 시스템 로그 서버*에 대해 구성된 경우 감사 메시지는 관리 노드에서 처리되고, 관리 도메인 컨트롤러(ADC) 서비스가 있는 스토리지 노드에서 처리됩니다.

감사 메시지 흐름도에 표시된 대로 각 StorageGRID 노드는 데이터 센터 사이트의 ADC 서비스 중 하나에 감사 메시지를 보냅니다. ADC 서비스는 각 사이트에 설치된 처음 세 개의 스토리지 노드에 대해 자동으로 활성화됩니다.

그러면 각 ADC 서비스가 릴레이 역할을 하고 감사 메시지 모음을 StorageGRID 시스템의 모든 관리 노드로 전송하여 각 관리 노드에 시스템 활동의 전체 기록을 제공합니다.

각 관리자 노드는 감사 메시지를 텍스트 로그 파일에 저장하며 활성 로그 파일의 이름은 `audit.log`지정됩니다.

image::../media/audit_message_flow.gif[릴레이를 통한 감사 메시지 흐름을 요약하는 다이어그램]



=== 감사 메시지 보존

StorageGRID는 복사 및 삭제 프로세스를 사용하여 감사 로그에 쓰기 전에 감사 메시지가 손실되지 않도록 합니다.

노드가 감사 메시지를 생성하거나 전달하면 해당 메시지는 그리드 노드의 시스템 디스크에 있는 감사 메시지 대기열에 저장됩니다.  메시지가 관리 노드의 감사 로그 파일에 기록될 때까지 메시지 사본은 항상 감사 메시지 대기열에 보관됩니다. `/var/local/audit/export` 예배 규칙서.  이는 전송 중 감사 메시지가 손실되는 것을 방지하는 데 도움이 됩니다.

image::../media/audit_message_retention.gif[AMS에서 감사 메시지 수신을 요약하는 다이어그램]

감사 메시지 대기열은 네트워크 연결 문제나 감사 용량 부족으로 인해 일시적으로 증가할 수 있습니다.  대기열이 증가함에 따라 각 노드의 사용 가능한 공간을 더 많이 소모합니다. `/var/local/` 예배 규칙서.  문제가 지속되고 노드의 감사 메시지 디렉토리가 너무 가득 차면 개별 노드는 백로그 처리를 우선시하고 일시적으로 새 메시지를 사용할 수 없게 됩니다.

특히 다음과 같은 행동을 볼 수 있습니다.

* 만약 `/var/local/audit/export` 관리 노드에서 사용하는 디렉토리가 가득 차면, 디렉토리가 더 이상 가득 차지 않을 때까지 관리 노드는 새 감사 메시지를 받을 수 없음으로 표시됩니다.  S3 클라이언트 요청은 영향을 받지 않습니다.  XAMS(도달할 수 없는 감사 저장소) 알람은 감사 저장소에 접근할 수 없을 때 발생합니다.
* 만약 `/var/local/` ADC 서비스가 있는 스토리지 노드에서 사용하는 디렉토리가 92% 채워지면, 디렉토리가 87%만 채워질 때까지 노드는 메시지를 감사할 수 없음으로 표시됩니다.  다른 노드에 대한 S3 클라이언트 요청은 영향을 받지 않습니다.  NRLY(사용 가능한 감사 릴레이) 알람은 감사 릴레이에 도달할 수 없을 때 발생합니다.
+

NOTE: ADC 서비스에 사용 가능한 저장소 노드가 없는 경우 저장소 노드는 감사 메시지를 파일에 로컬로 `/var/local/log/localaudit.log` 저장합니다.

* 만약 `/var/local/` 스토리지 노드에서 사용하는 디렉토리가 85% 채워지면 노드는 S3 클라이언트 요청을 거부하기 시작합니다. `503 Service Unavailable` .


다음과 같은 유형의 문제로 인해 감사 메시지 큐가 크게 증가할 수 있습니다.

* ADC 서비스가 있는 관리 노드 또는 스토리지 노드의 정전. 시스템의 노드 중 하나가 다운되면 나머지 노드가 백로그될 수 있습니다.
* 시스템의 감사 용량을 초과하는 지속적인 활동률입니다.
*  `/var/local/`감사 메시지와 무관한 이유로 ADC 저장소 노드의 공간이 가득 차있습니다. 이 경우 노드에서 새 감사 메시지 수신을 중지하고 현재 백로그의 우선 순위를 지정하며, 이로 인해 다른 노드에 백로그가 발생할 수 있습니다.




=== AMQS(Large audit queue alert and Audit messages Queued)(대형 감사 대기열 경고 및 감사 메시지 대기 중

시간에 따라 감사 메시지 대기열의 크기를 모니터링할 수 있도록 스토리지 노드 대기열 또는 관리 노드 대기열의 메시지 수가 특정 임계값에 도달하면 * 대규모 감사 대기열 * 경고와 레거시 AMQS 경보가 트리거됩니다.

대규모 감사 대기열 * 경고 또는 레거시 AMQS 경보가 트리거되면 시스템에서 로드를 확인하여 시작합니다. -- 최근 트랜잭션이 많이 발생한 경우, 경고 및 알람은 시간이 지남에 따라 해결되어야 하며 무시할 수 있습니다.

경고나 알람이 지속되고 심각도가 높아지면 대기열 크기 차트를 확인하세요.  숫자가 몇 시간 또는 며칠 동안 꾸준히 증가한다면 감사 부하가 시스템의 감사 용량을 초과했을 가능성이 높습니다.  클라이언트 쓰기 및 클라이언트 읽기에 대한 감사 수준을 오류 또는 꺼짐으로 변경하여 클라이언트 작업 속도를 줄이거나 기록되는 감사 메시지 수를 줄입니다. 보다 link:../monitor/configure-log-management.html["로그 관리 및 외부 syslog 서버 구성"] .



=== 중복된 메시지

StorageGRID 시스템은 네트워크 또는 노드 장애가 발생할 경우 보수적인 접근 방식을 사용합니다. 따라서 감사 로그에 중복된 메시지가 있을 수 있습니다.
